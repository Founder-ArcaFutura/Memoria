version: '3.9'
services:
  db:
    image: postgres:15
    restart: always
    env_file:
      - .env
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
  api:
    build: .
    depends_on:
      - db
    env_file:
      - .env
    ports:
      - "8080:8000"
    volumes:
      - memoria-data:/data
      - sqlite-data:/workspace/sqlite
    healthcheck:
      test: |
        python - <<'PY'
        import os
        import sys
        import urllib.error
        import urllib.request

        url = "http://127.0.0.1:8000/settings"
        headers = {"X-API-Key": os.environ.get("MEMORIA_API_KEY", "")}

        request = urllib.request.Request(url, headers=headers)
        try:
            with urllib.request.urlopen(request, timeout=10) as response:
                status = getattr(response, "status", response.getcode())
                sys.exit(0 if status < 500 else 1)
        except urllib.error.HTTPError as exc:
            sys.exit(0 if exc.code < 500 else 1)
        except Exception:
            sys.exit(1)
        PY
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
volumes:
  db-data:
  memoria-data:
  sqlite-data:
